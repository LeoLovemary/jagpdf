# -*- mode: sh -*-

set +e
npackages=`aptitude search jagpdf | grep -e '^i' | wc -l`
set -e
if [ "$npackages" != "0" ]; then
    echo 'Found these jagpdf packages:'
    aptitude search jagpdf | grep -e '^i'
    echo 'Remove them before using this script.'
    exit 1
fi

function create_lib_link()
{
    TARGET=$1
    LINK=$2

    if [ ! -h $LINK/lib ]; then
        mkdir $LINK
        ln -s $TARGET $LINK/lib
    fi
}


# ------------------------------------------------------------
#                          C/C++

install_deb jagpdf-$CFG_VERSION.$CFG_PLATFORM.c_cpp.deb
do_test /usr
remove_deb libjagpdf

# ------------------------------------------------------------
#                           PYTHON


function test_python()
{
    M_m=$1
    Mm=${M_m//./}

    install_deb jagpdf-$CFG_VERSION.$CFG_PLATFORM.py$Mm.deb

    if [ ! -h jagpdf-python$M_m/lib ]; then
        mkdir jagpdf-python$M_m
        ln -s /var/lib/python-support/python$M_m jagpdf-python$M_m/lib
    fi

    create_lib_link /var/lib/python-support/python$M_m jagpdf-python$M_m

    do_test \
        jagpdf-python$M_m \
        -DPYTHON_EXECUTABLE=/usr/bin/python$M_m
    remove_deb python$M_m-jagpdf
}

test_python 2.5
test_python 2.4


# ------------------------------------------------------------
#                           JAVA

install_deb jagpdf-$CFG_VERSION.$CFG_PLATFORM.java.deb

function test_java()
{
    JAVA_HOME=$1

    create_lib_link /usr/share/java jagpdf-java
    do_test jagpdf-java -DCMAKE_PREFIX_PATH=$1
}

(
    export LD_LIBRARY_PATH=/usr/lib/jni ;
    test_java /home/jarda/src/java/jdk1.5.0_21/ ;
    test_java /home/jarda/src/java/jdk1.6.0_16 ;
    test_java /usr/lib/jvm/java-1.5.0-sun ;
    test_java /usr/lib/jvm/java-6-sun/ ;
    test_java /usr/lib/jvm/java-6-openjdk/ ;
)

remove_deb java-jagpdf


# ------------------------------------------------------------
#                      BUILD AND TEST SOURCES

source ~/.jagbase.cfg

rm -rf build.from.sources
mkdir build.from.sources
cd build.from.sources
env BOOST_ROOT=$JAG_BOOST_ROOT cmake -DJAVA_HOME=$JAG_JAVA_HOME ../jagpdf-$CFG_VERSION
make -j 4
make unit-tests
make apitests


